---
date: 2026-01-16T02:15:00-03:00
session_name: general
topic: "BLE Deduplication Fix Needed"
status: in_progress
---

# Handoff: Deduplication Not Working

## Completed
- ✅ Messages from Android received
- ✅ Sender name lookup added (but still shows UID - need to verify timing)

## Bug: Deduplication Not Working

**Root cause:** Each decoded message gets NEW ID:
```dart
// lib/data/models/bitchat_message.dart:168
id: DateTime.now().millisecondsSinceEpoch.toString(),
```

**Fix needed:** Generate deterministic ID from content + packet timestamp:
```dart
// Use hash of content + sender + timestamp for stable ID
final idSource = '$content-$peerID-${packet.timestamp.millisecondsSinceEpoch}';
id: idSource.hashCode.toString(),
```

**File to edit:** `lib/data/models/bitchat_message.dart:167-168`

## Evidence
```
[BluetoothMeshService] Chat message from 813654e4c15d2c8d: "hola desde android"
[ChatNotifier] didReceiveMessage: hola desde android
[BluetoothMeshService] Chat message from 813654e4c15d2c8d: "hola desde android"
[ChatNotifier] didReceiveMessage: hola desde android  // DUPLICATE - not filtered!
```

## Quick Fix
In `fromBinaryPayload()`, generate ID from content hash instead of timestamp.
